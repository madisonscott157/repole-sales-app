<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>Repole Sales</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/colreorder/1.7.0/css/colReorder.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.bootstrap5.min.css" rel="stylesheet">
    <!-- Persistent File Storage CSS -->
    <link rel="stylesheet" href="/public/styles.css">
    
    <style>
        .drop-zone {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .drop-zone:hover {
            border-color: #0056b3;
            background-color: rgba(25, 25, 112, 0.1);
        }
        .drop-zone.dragover {
            border-color: #28a745;
            background-color: #e8f5e9;
        }
        .file-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .overlap-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 5px;
            text-align: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .overlap-1 { background-color: #007bff; }
        .overlap-2 { background-color: #28a745; }
        .overlap-3 { background-color: #ffc107; color: black; }
        .overlap-4 { background-color: #dc3545; }
        .overlap-5plus { background-color: #6f42c1; }
        .custom-column {
            background-color: #e3f2fd !important;
        }
        .editable-cell {
            cursor: pointer;
            border: 1px solid transparent;
        }
        .editable-cell:hover {
            border: 1px solid #007bff;
            background-color: rgba(25, 25, 112, 0.1);
        }
        .editing {
            background-color: #fff3cd !important;
        }
        .stats-card {
            background: #1e3a8a;
            color: #ff6600;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 5px;
            text-align: center;
            min-width: 120px;
        }
        .stats-card h6 {
            font-size: 11px;
            margin: 0 0 2px 0;
            opacity: 0.9;
        }
        .stats-card .stat-number {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        .stats-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .shortlist-tag {
            display: inline-block;
            padding: 2px 8px;
            margin: 1px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .excel-table {
            border-collapse: collapse;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            background-color: white;
        }
        .excel-table th {
            background-color: #f2f2f2;
            border: 1px solid #d0d7de;
            padding: 8px 12px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        .excel-table td {
            border: 1px solid #d0d7de;
            padding: 6px 8px;
            text-align: center;
            background-color: white;
            white-space: nowrap;
        }
        .excel-table tbody tr:hover {
            background-color: rgba(25, 25, 112, 0.1);
        }
        .excel-table .horse-info {
            text-align: left;
            min-width: 120px;
        }
        .excel-table .hip-column {
            width: 60px;
            font-weight: bold;
        }
        .grade-cell {
            font-weight: bold;
            min-width: 80px;
        }
        .grade-A { background-color: #d4edda !important; color: #155724; }
        .grade-A-plus { background-color: #c3e6cb !important; color: #155724; }
        .grade-B { background-color: #cce5ff !important; color: #004085; }
        .grade-B-plus { background-color: #b3d9ff !important; color: #004085; }
        .grade-C { background-color: #fff3cd !important; color: #856404; }
        .grade-D { background-color: #f8d7da !important; color: #721c24; }
        .table-container {
            max-height: 95vh;
            overflow: auto;
            border: 2px solid rgba(25, 25, 112, 0.2);
            border-radius: 8px;
            width: 100%;
            margin: 0 auto;
        }
        .shortlist-header {
            background-color: #e3f2fd !important;
            color: #1976d2;
            font-weight: bold;
        }
        
        /* Enhanced table features */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px !important;
        }
        .sortable-header:hover {
            background-color: rgba(25, 25, 112, 0.15) !important;
        }
        .sort-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .sortable-header:hover .sort-icon {
            opacity: 0.7;
        }
        .sort-icon.active {
            opacity: 1;
            color: #007bff;
        }
        
        /* Filter row */
        .filter-row {
            background-color: rgba(25, 25, 112, 0.1);
        }
        .filter-input {
            width: 100%;
            border: 1px solid rgba(25, 25, 112, 0.2);
            padding: 4px 6px;
            font-size: 11px;
            border-radius: 3px;
        }
        .filter-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        /* Navy button theme */
        .btn-primary, .btn-secondary, .btn-outline-primary, .btn-outline-secondary, .btn-outline-info, .btn-success {
            background-color: #1e3a8a !important;
            border-color: #1e3a8a !important;
            color: white !important;
        }
        .btn-primary:hover, .btn-secondary:hover, .btn-outline-primary:hover, .btn-outline-secondary:hover, .btn-outline-info:hover, .btn-success:hover {
            background-color: #1e40af !important;
            border-color: #1e40af !important;
            color: white !important;
        }
        
        /* Column management */
        .column-controls {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .column-checkbox {
            margin-right: 15px;
            margin-bottom: 8px;
        }
        .column-checkbox input {
            margin-right: 5px;
        }
        .column-reorder {
            max-width: 200px;
        }
        
        /* Drag and drop */
        .dragging {
            opacity: 0.5;
        }
        .drop-indicator {
            width: 3px;
            background-color: #007bff;
            position: absolute;
            top: 0;
            bottom: 0;
            z-index: 1000;
        }
        
        /* iPad and touch device optimizations */
        @media (max-width: 1024px) and (orientation: portrait), 
               (max-width: 1366px) and (orientation: landscape) {
            /* iPad specific styles */
            .btn {
                min-height: 44px; /* Apple's recommended touch target size */
                padding: 8px 16px;
                font-size: 16px; /* Prevent zoom on iOS */
            }
            .btn-sm {
                min-height: 38px;
                padding: 6px 12px;
                font-size: 14px;
            }
            .form-control, .form-select {
                min-height: 44px;
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 8px 12px;
            }
            .table-container {
                max-height: 65vh;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
                overflow: auto;
            }
            .excel-table th, .excel-table td {
                padding: 8px 12px;
                min-width: 80px;
            }
            .editable-cell {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            .filter-input {
                min-height: 38px;
                font-size: 14px;
                padding: 6px 10px;
            }
            /* Better touch targets for column controls */
            .column-checkbox {
                margin: 8px 12px 8px 0;
                font-size: 14px;
            }
            .column-checkbox input[type="checkbox"] {
                width: 18px;
                height: 18px;
                margin-right: 8px;
            }
        }

        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .excel-table {
                font-size: 12px;
            }
            .excel-table th, .excel-table td {
                padding: 6px 8px;
                min-width: 60px;
            }
            .table-container {
                max-height: 60vh;
            }
            .column-controls {
                padding: 15px;
            }
            .stats-card {
                min-width: 120px;
                padding: 8px 12px;
                margin: 8px 4px;
            }
            .stats-card h6 {
                font-size: 12px;
            }
            .stats-card .stat-number {
                font-size: 18px;
            }
        }
        
        @media (max-width: 576px) {
            .excel-table {
                font-size: 11px;
            }
            .excel-table th, .excel-table td {
                padding: 4px 6px;
                min-width: 50px;
            }
            .btn {
                font-size: 14px;
                padding: 6px 12px;
            }
        }

        /* Touch-specific improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Remove hover effects on touch devices */
            .editable-cell:hover {
                background-color: inherit !important;
                border: 1px solid transparent !important;
            }
            /* Add active/focus states for touch */
            .editable-cell:active,
            .editable-cell:focus {
                background-color: #f0f8ff !important;
                border: 2px solid #007bff !important;
                outline: none;
            }
            .btn:active {
                transform: scale(0.98);
            }
        }
        
        /* Edit cell enhancements */
        .editable-cell {
            cursor: pointer;
            position: relative;
        }
        .editable-cell:hover {
            background-color: #f0f8ff !important;
            border: 1px solid #007bff !important;
        }
        .editable-cell.editing {
            padding: 0 !important;
        }
        .edit-input, .edit-select {
            width: 100%;
            border: 2px solid #007bff;
            padding: 8px;
            font-size: 16px; /* Prevent zoom on iOS */
            background-color: white;
            border-radius: 4px;
            min-height: 44px; /* Touch target size */
        }
        .edit-input:focus, .edit-select:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        
        /* Modal optimizations for iPad */
        @media (max-width: 1024px) {
            .modal-dialog {
                margin: 20px auto;
                max-width: 90%;
            }
            .modal-body {
                padding: 20px;
            }
            .modal-header .btn-close {
                padding: 12px;
                margin: -12px;
            }
        }
        
        /* Dropdown optimizations */
        .dropdown-menu {
            font-size: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .dropdown-item {
            padding: 12px 16px;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        
        /* File upload area improvements */
        .file-upload {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .file-upload:hover,
        .file-upload.dragover {
            background-color: #f8f9fa;
            border-color: #0056b3;
        }
        
        /* iPad & Mobile Fixes - Both orientations */
        @media (max-width: 1024px) {
            /* Compact button layout - preserve functionality */
            .btn {
                min-height: 44px; /* Touch target size */
                padding: 8px 16px;
                font-size: 16px; /* Prevent zoom on iOS */
                margin: 2px;
                border-radius: 4px;
            }
            
            /* Smaller buttons for space efficiency */
            .btn-sm {
                min-height: 38px;
                padding: 6px 12px;
                font-size: 14px;
            }
            
            /* More compact action sections */
            .stats-row {
                gap: 5px !important;
                margin: 5px 0 !important;
            }
            
            .stats-card {
                padding: 4px 8px !important;
                margin: 2px !important;
                min-width: 100px !important;
            }
            
            .stats-card h6 {
                font-size: 10px !important;
                margin: 0 !important;
            }
            
            .stats-card .stat-number {
                font-size: 16px !important;
            }
            
            /* Container fixes */
            .table-responsive {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                width: 100% !important;
            }
            
            /* Force table to behave properly */
            #mainTable {
                display: table !important; 
                width: auto !important;
                table-layout: auto !important;
                border-collapse: collapse !important;
            }
            
            #mainTable thead {
                display: table-header-group !important;
            }
            
            #mainTable tbody {
                display: table-row-group !important;
            }
            
            #mainTable tr {
                display: table-row !important;
                height: auto !important;
            }
            
            #mainTable th,
            #mainTable td {
                display: table-cell !important;
                padding: 4px 6px !important;
                font-size: 12px !important;
                border: 1px solid #ddd !important;
                background-color: white !important;
                vertical-align: top !important;
                text-align: left !important;
                box-sizing: border-box !important;
                word-wrap: break-word !important;
                white-space: normal !important;
                line-height: 1.2 !important;
                max-width: none !important;
                width: auto !important;
            }
            
            /* Header styling - no wrap for headers */
            #mainTable th {
                background-color: #f8f9fa !important;
                font-weight: bold !important;
                border-bottom: 2px solid #007bff !important;
                white-space: nowrap !important;
                padding: 6px 8px !important;
            }
            
            /* Dynamic column widths based on header text width */
            #mainTable th:nth-child(1), #mainTable td:nth-child(1) { max-width: 50px; }    /* Hip - short */
            #mainTable th:nth-child(2), #mainTable td:nth-child(2) { max-width: 120px; }   /* Name */
            #mainTable th:nth-child(3), #mainTable td:nth-child(3) { max-width: 80px; }    /* Sire */
            #mainTable th:nth-child(4), #mainTable td:nth-child(4) { max-width: 80px; }    /* Dam */
            #mainTable th:nth-child(5), #mainTable td:nth-child(5) { max-width: 40px; }    /* Sex */
            #mainTable th:nth-child(6), #mainTable td:nth-child(6) { max-width: 50px; }    /* YOB */
            #mainTable th:nth-child(7), #mainTable td:nth-child(7) { max-width: 100px; }   /* Consignor */
            #mainTable th:nth-child(8), #mainTable td:nth-child(8) { max-width: 80px; }    /* Pinhook */
            
            /* Additional columns */
            #mainTable th:nth-child(n+9), #mainTable td:nth-child(n+9) { 
                max-width: 80px;
            }
        }
        
        /* Portrait orientation - more compact */
        @media (max-width: 1024px) and (orientation: portrait) {
            #mainTable th,
            #mainTable td {
                font-size: 11px !important;
                padding: 3px 4px !important;
            }
        }
        
        /* Landscape orientation - slightly more space */
        @media (max-width: 1024px) and (orientation: landscape) {
            .container-fluid {
                padding: 10px !important;
            }
            
            #mainTable th,
            #mainTable td {
                font-size: 12px !important;
                padding: 4px 6px !important;
            }
            
            /* Slightly wider max-widths in landscape */
            #mainTable th:nth-child(2), #mainTable td:nth-child(2) { max-width: 140px; }   /* Name */
            #mainTable th:nth-child(3), #mainTable td:nth-child(3) { max-width: 100px; }   /* Sire */
            #mainTable th:nth-child(4), #mainTable td:nth-child(4) { max-width: 100px; }   /* Dam */
            #mainTable th:nth-child(7), #mainTable td:nth-child(7) { max-width: 120px; }   /* Consignor */
            #mainTable th:nth-child(8), #mainTable td:nth-child(8) { max-width: 100px; }   /* Pinhook */
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center my-4">Repole Stable Sales</h1>
            </div>
        </div>

        <!-- Sale Day Selector -->
        <div class="row" id="saleDaySection">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Sale Management</h5>
                        <div>
                            <button class="btn btn-primary btn-sm" id="newSaleBtn">
                                <i class="fas fa-plus"></i> New Sale Day
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="saleSelector" class="form-label">Current Sale:</label>
                                <select class="form-select" id="saleSelector">
                                    <option value="">Select a sale day...</option>
                                </select>
                            </div>
                            <div class="col-md-8" id="currentSaleInfo">
                                <small class="text-muted">No sale selected</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="row" id="uploadSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Shortlist Files</h5>
                        <div>
                            <button class="btn btn-primary btn-sm" id="uploadBtn">
                                <i class="fas fa-upload"></i> Upload Files
                            </button>
                            <button class="btn btn-success btn-sm ms-2" id="combineBtn" disabled>
                                <i class="fas fa-merge"></i> Combine
                            </button>
                            <button class="btn btn-secondary btn-sm ms-2" id="clearBtn">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <input type="file" id="fileInput" multiple accept=".csv,.xlsx,.xls" style="display: none;">
                        <div id="fileList" class="file-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="row" id="statsSection" style="display: none;">
            <div class="col-12">
                <div class="stats-row">
                    <div class="stats-card">
                        <h6>Unique Horses</h6>
                        <div class="stat-number" id="uniqueHorses">0</div>
                    </div>
                    <div class="stats-card">
                        <h6>Colts</h6>
                        <div class="stat-number" id="coltCount">0</div>
                    </div>
                    <div class="stats-card">
                        <h6>Fillies</h6>
                        <div class="stat-number" id="fillyCount">0</div>
                    </div>
                    <div class="stats-card">
                        <h6>Vetting</h6>
                        <div class="stat-number" id="vettingCount">0</div>
                    </div>
                    <div class="stats-card">
                        <h6>Overlapping</h6>
                        <div class="stat-number" id="overlappingHorses">0</div>
                    </div>
                    <div class="stats-card">
                        <h6>Shortlists</h6>
                        <div class="stat-number" id="shortlistCount">0</div>
                    </div>
                    <div class="stats-card">
                        <h6>Purchased</h6>
                        <div class="stat-number" id="purchasedCount">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="row" id="controlsSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
                        <h3>Combined Shortlist</h3>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-primary" id="exportCsvBtn">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                            <button class="btn btn-primary" id="exportPdfBtn">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                            <button class="btn btn-primary" id="addColumnBtn">
                                <i class="fas fa-plus"></i> Add Column
                            </button>
                            <button class="btn btn-primary" id="shareBtn">
                                <i class="fas fa-share"></i> Share Link
                            </button>
                            <button class="btn btn-success" id="addHorseBtn">
                                <i class="fas fa-plus"></i> Add New Horse
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Column Controls -->
                        <div class="column-controls" id="columnControls">
                            <div class="row">
                                <div class="col-md-7">
                                    <h6><i class="fas fa-eye"></i> Show/Hide Columns:</h6>
                                    <div id="columnCheckboxes" class="d-flex flex-wrap">
                                        <!-- Column checkboxes will be inserted here -->
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <h6>Actions:</h6>
                                    <div class="row g-1">
                                        <div class="col-6">
                                            <button class="btn btn-sm btn-outline-secondary w-100" id="selectAllBtn">Select All</button>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-sm btn-outline-secondary w-100" id="resetColumnsBtn">Reset</button>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-sm btn-outline-info w-100" id="toggleFiltersBtn">
                                                <i class="fas fa-filter"></i> Filters
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-sm w-100" id="clearFiltersBtn" style="background-color: transparent; border: 1px solid #ff6600; color: #ff6600;">
                                                <i class="fas fa-eraser"></i> Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <h6><i class="fas fa-arrows-alt"></i> Reorder Columns:</h6>
                                    <select class="form-select column-reorder mb-2" id="columnReorder">
                                        <option value="">Select column to move...</option>
                                    </select>
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-sm btn-outline-primary" id="moveLeftBtn">← Left</button>
                                        <button class="btn btn-sm btn-outline-primary" id="moveRightBtn">Right →</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Table Container -->
                        <div class="table-container">
                            <table id="mainTable" class="excel-table">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- New Sale Day Modal -->
    <div class="modal fade" id="newSaleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Sale Day</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="saleName" class="form-label">Sale Name</label>
                        <input type="text" class="form-control" id="saleName" placeholder="e.g. Keeneland September 2024">
                    </div>
                    <div class="mb-3">
                        <label for="saleDate" class="form-label">Sale Date</label>
                        <input type="date" class="form-control" id="saleDate">
                    </div>
                    <div class="mb-3">
                        <label for="saleLocation" class="form-label">Location (Optional)</label>
                        <input type="text" class="form-control" id="saleLocation" placeholder="e.g. Keeneland, Lexington, KY">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createSaleBtn">Create Sale</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Sales Modal -->
    <div class="modal fade" id="editSalesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Sales Days</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="salesList">
                        <!-- Sales will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Sale Modal -->
    <div class="modal fade" id="renameSaleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rename Sale Day</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editSaleName" class="form-label">Sale Name</label>
                        <input type="text" class="form-control" id="editSaleName">
                    </div>
                    <div class="mb-3">
                        <label for="editSaleDate" class="form-label">Sale Date</label>
                        <input type="date" class="form-control" id="editSaleDate">
                    </div>
                    <div class="mb-3">
                        <label for="editSaleLocation" class="form-label">Location (Optional)</label>
                        <input type="text" class="form-control" id="editSaleLocation">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSaleChangesBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Column Modal -->
    <div class="modal fade" id="addColumnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Custom Column</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="columnName" class="form-label">Column Name</label>
                        <input type="text" class="form-control" id="columnName" placeholder="Enter column name">
                    </div>
                    <div class="mb-3">
                        <label for="columnType" class="form-label">Column Type</label>
                        <select class="form-select" id="columnType">
                            <option value="text">Text</option>
                            <option value="number">Number</option>
                            <option value="select">Dropdown</option>
                        </select>
                    </div>
                    <div class="mb-3" id="selectOptions" style="display: none;">
                        <label for="optionsList" class="form-label">Options (comma-separated)</label>
                        <input type="text" class="form-control" id="optionsList" placeholder="Option1, Option2, Option3">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveColumnBtn">Add Column</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Name Input Modal -->
    <div class="modal fade" id="nameModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Shortlist Owner</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Who's shortlist is this?</p>
                    <div class="mb-3">
                        <label for="shortlistOwner" class="form-label">Name</label>
                        <input type="text" class="form-control" id="shortlistOwner" placeholder="Enter person's name">
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">File: <span id="currentFileName"></span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNameBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PIN Entry Modal -->
    <div class="modal fade" id="pinModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Access</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Enter admin PIN to access administrative features:</p>
                    <div class="mb-3">
                        <label for="adminPin" class="form-label">PIN</label>
                        <input type="password" class="form-control" id="adminPin" placeholder="Enter PIN" maxlength="4">
                    </div>
                    <div id="pinError" class="text-danger" style="display: none;">Incorrect PIN</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="verifyPinBtn">Enter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal fade" id="adminPanelModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Panel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6>Sale Management</h6>
                        <div id="adminSalesList">
                            <!-- Sales will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="exitAdminBtn">Exit Admin Mode</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Share Combined Shortlist</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Copy this link to share your combined shortlist:</p>
                    <div class="input-group">
                        <input type="text" class="form-control" id="shareLink" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copyLinkBtn">Copy</button>
                    </div>
                    <small class="text-muted">Note: This creates a data URL that contains all your data. The link may be very long.</small>
                </div>
            </div>
        </div>
    </div>


    <!-- Admin Panel Modal -->
    <div class="modal fade" id="adminPanelModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Panel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Manage Sales Days</h6>
                    <div id="adminSalesList">
                        <!-- Sales list will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="exitAdminBtn">Exit Admin Mode</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/colreorder/1.7.0/js/dataTables.colReorder.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        class ShortlistCombiner {
            constructor() {
                this.files = [];
                this.combinedData = [];
                this.table = null;
                this.customColumns = [];
                this.pendingFile = null; // For storing file while waiting for name
                this.columnOrder = []; // Track column order
                this.hiddenColumns = new Set(); // Track hidden columns
                this.sortState = { column: null, direction: 'asc' }; // Track sort state
                this.filters = {}; // Track column filters
                this.filtersVisible = false; // Track filter row visibility
                
                // Multi-day functionality
                this.currentSaleId = null;
                this.salesData = new Map(); // Store all sale days data
                
                // Admin functionality
                this.isAdmin = false;
                this.adminSessionTimeout = null;
                this.ADMIN_PIN = '42';
                this.ADMIN_TIMEOUT = 30 * 60 * 1000; // 30 minutes
                
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadSalesData();
                this.loadFromURL();
                this.updateSaleSelector();
                this.addAdminButton(); // Add the LOST numbers button
                this.updateAdminButtonVisibility(); // Set initial button visibility
            }

            setupEventListeners() {
                const fileInput = document.getElementById('fileInput');

                // Upload button
                const uploadBtn = document.getElementById('uploadBtn');
                uploadBtn.addEventListener('click', () => fileInput.click());

                // File input
                fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                });

                // Buttons
                document.getElementById('combineBtn').addEventListener('click', () => this.combineData());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearAll());
                document.getElementById('exportCsvBtn').addEventListener('click', () => this.exportCSV());
                document.getElementById('exportPdfBtn').addEventListener('click', () => this.exportPDF());
                document.getElementById('addColumnBtn').addEventListener('click', () => this.showAddColumnModal());
                document.getElementById('shareBtn').addEventListener('click', () => this.generateShareLink());
                document.getElementById('saveColumnBtn').addEventListener('click', () => this.addCustomColumn());
                document.getElementById('copyLinkBtn').addEventListener('click', () => this.copyShareLink());
                document.getElementById('saveNameBtn').addEventListener('click', () => this.saveShortlistName());
                document.getElementById('addHorseBtn').addEventListener('click', () => this.addNewHorse());
                
                // Admin functionality
                document.getElementById('verifyPinBtn').addEventListener('click', () => this.verifyPin());
                document.getElementById('exitAdminBtn').addEventListener('click', () => this.exitAdminMode());
                document.getElementById('adminPin').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.verifyPin();
                    }
                });
                
                // Multi-day event listeners
                document.getElementById('newSaleBtn').addEventListener('click', () => this.showNewSaleModal());
                document.getElementById('createSaleBtn').addEventListener('click', () => this.createNewSale());
                document.getElementById('saleSelector').addEventListener('change', () => this.switchSale());
                document.getElementById('saveSaleChangesBtn').addEventListener('click', () => this.saveSaleChanges());
                
                
                // Column control event listeners
                document.getElementById('selectAllBtn').addEventListener('click', () => this.selectAllColumns());
                document.getElementById('resetColumnsBtn').addEventListener('click', () => this.resetColumnLayout());
                document.getElementById('toggleFiltersBtn').addEventListener('click', () => this.toggleFilters());
                document.getElementById('clearFiltersBtn').addEventListener('click', () => this.clearAllFilters());
                document.getElementById('moveLeftBtn').addEventListener('click', () => this.moveColumn('left'));
                document.getElementById('moveRightBtn').addEventListener('click', () => this.moveColumn('right'));

                // Column type change
                document.getElementById('columnType').addEventListener('change', (e) => {
                    document.getElementById('selectOptions').style.display = 
                        e.target.value === 'select' ? 'block' : 'none';
                });

                // Enter key support for name modal
                document.getElementById('shortlistOwner').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.saveShortlistName();
                    }
                });

                // Add admin button to page (hidden by default)
                this.addAdminButton();
            }

            // ========== MULTI-DAY STORAGE METHODS ==========
            // Designed to be easily swappable with Upstash Redis API calls

            async loadSalesData() {
                try {
                    const response = await fetch('https://repole-sales-app.vercel.app/api/sales');
                    const result = await response.json();
                    
                    if (response.ok && result.sales) {
                        this.salesData = new Map(Object.entries(result.sales));
                    } else {
                        this.salesData = new Map();
                    }
                } catch (error) {
                    console.error('Error loading sales data:', error);
                    this.salesData = new Map();
                }
            }

            async saveSalesData() {
                try {
                    for (const [saleId, saleData] of this.salesData.entries()) {
                        await fetch('https://repole-sales-app.vercel.app/api/sales', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                saleId: saleId,
                                saleData: saleData
                            })
                        });
                    }
                    console.log('Sales data saved to Redis');
                } catch (error) {
                    console.error('Error saving sales data:', error);
                }
            }

            async saveSaleDay(saleId) {
                if (!saleId || !this.salesData.has(saleId)) return;

                const saleData = {
                    files: this.files,
                    combinedData: this.combinedData,
                    customColumns: this.customColumns,
                    columnOrder: this.columnOrder,
                    hiddenColumns: Array.from(this.hiddenColumns),
                    sortState: this.sortState,
                    filters: this.filters,
                    filtersVisible: this.filtersVisible,
                    lastUpdated: new Date().toISOString()
                };

                // Update the sale's data
                const saleInfo = this.salesData.get(saleId);
                saleInfo.data = saleData;
                this.salesData.set(saleId, saleInfo);

                await this.saveSalesData();
            }

            async loadSaleDay(saleId) {
                if (!saleId || !this.salesData.has(saleId)) return false;

                const saleInfo = this.salesData.get(saleId);
                const saleData = saleInfo.data;

                if (!saleData) return false;

                // Load sale day data
                this.files = saleData.files || [];
                this.combinedData = saleData.combinedData || [];
                this.customColumns = saleData.customColumns || [];
                this.columnOrder = saleData.columnOrder || [];
                this.hiddenColumns = new Set(saleData.hiddenColumns || []);
                this.sortState = saleData.sortState || { column: null, direction: 'asc' };
                this.filters = saleData.filters || {};
                this.filtersVisible = saleData.filtersVisible || false;

                // Also load files from persistent storage for this sale
                await this.loadPersistentFilesForSale(saleId);

                return true;
            }

            async loadPersistentFilesForSale(saleId) {
                // Files are stored in localStorage as part of the sale data
                // No separate API call needed for GitHub Pages deployment
                console.log(`Files for sale ${saleId} loaded from localStorage`);
            }

            generateSaleId(saleName, saleDate) {
                // Create a unique ID from name and date
                const cleanName = saleName.toLowerCase().replace(/[^a-z0-9]/g, '_');
                return `${saleDate}_${cleanName}`;
            }

            updateSaleSelector() {
                const selector = document.getElementById('saleSelector');
                selector.innerHTML = '<option value="">Select a sale day...</option>';

                // Sort sales by date (newest first)
                const sortedSales = Array.from(this.salesData.entries()).sort((a, b) => {
                    return new Date(b[1].saleDate) - new Date(a[1].saleDate);
                });

                sortedSales.forEach(([saleId, saleInfo]) => {
                    const option = document.createElement('option');
                    option.value = saleId;
                    option.textContent = `${saleInfo.saleName} (${new Date(saleInfo.saleDate).toLocaleDateString()})`;
                    if (saleId === this.currentSaleId) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
            }

            updateCurrentSaleInfo() {
                const infoDiv = document.getElementById('currentSaleInfo');
                if (!this.currentSaleId || !this.salesData.has(this.currentSaleId)) {
                    infoDiv.innerHTML = '<small class="text-muted">No sale selected</small>';
                    return;
                }

                const saleInfo = this.salesData.get(this.currentSaleId);
                const lastUpdated = saleInfo.data?.lastUpdated ? 
                    new Date(saleInfo.data.lastUpdated).toLocaleString() : 'Never';

                infoDiv.innerHTML = `
                    <div>
                        <strong>${saleInfo.saleName}</strong> - ${new Date(saleInfo.saleDate).toLocaleDateString()}
                        ${saleInfo.location ? `<br><small class="text-muted">${saleInfo.location}</small>` : ''}
                    </div>
                `;
            }

            showNewSaleModal() {
                const modal = new bootstrap.Modal(document.getElementById('newSaleModal'));
                // Set default date to today
                document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
                modal.show();
            }

            async createNewSale() {
                const saleName = document.getElementById('saleName').value.trim();
                const saleDate = document.getElementById('saleDate').value;
                const location = document.getElementById('saleLocation').value.trim();

                if (!saleName || !saleDate) {
                    alert('Please enter a sale name and date');
                    return;
                }

                const saleId = this.generateSaleId(saleName, saleDate);
                
                if (this.salesData.has(saleId)) {
                    alert('A sale with this name and date already exists');
                    return;
                }

                // Create new sale
                const saleInfo = {
                    saleId,
                    saleName,
                    saleDate,
                    location,
                    created: new Date().toISOString(),
                    data: null // Will be populated when first saved
                };

                this.salesData.set(saleId, saleInfo);
                await this.saveSalesData();

                // Switch to new sale
                this.currentSaleId = saleId;
                this.resetForNewSale();
                this.updateSaleSelector();
                this.updateCurrentSaleInfo();
                this.showWorkingSections();

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('newSaleModal')).hide();
                
                // Clear form
                document.getElementById('saleName').value = '';
                document.getElementById('saleDate').value = '';
                document.getElementById('saleLocation').value = '';
            }

            async switchSale() {
                const selector = document.getElementById('saleSelector');
                const selectedSaleId = selector.value;

                if (!selectedSaleId) {
                    this.currentSaleId = null;
                    this.hideWorkingSections();
                    this.updateCurrentSaleInfo();
                    return;
                }

                // Save current sale if exists
                if (this.currentSaleId) {
                    await this.saveSaleDay(this.currentSaleId);
                }

                // Load selected sale
                this.currentSaleId = selectedSaleId;
                const loaded = await this.loadSaleDay(selectedSaleId);

                if (loaded) {
                    this.updateFileList();
                    this.updateCombineButton();
                    if (this.combinedData.length > 0) {
                        this.createTable();
                        this.updateStats();
                        this.showResults();
                    }
                } else {
                    this.resetForNewSale();
                }

                this.updateCurrentSaleInfo();
                this.showWorkingSections();
            }

            resetForNewSale() {
                // Reset all state for a new sale
                this.files = [];
                this.combinedData = [];
                this.customColumns = [];
                this.columnOrder = [];
                this.hiddenColumns = new Set();
                this.sortState = { column: null, direction: 'asc' };
                this.filters = {};
                this.filtersVisible = false;

                // Clear UI
                document.getElementById('fileList').innerHTML = '';
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('controlsSection').style.display = 'none';
                if (this.table) {
                    this.table.destroy();
                    this.table = null;
                }
                document.querySelector('#mainTable thead').innerHTML = '';
                document.querySelector('#mainTable tbody').innerHTML = '';
                this.updateCombineButton();
            }

            showEditSalesModal() {
                this.populateEditSalesModal();
                const modal = new bootstrap.Modal(document.getElementById('editSalesModal'));
                modal.show();
            }

            populateEditSalesModal() {
                const salesList = document.getElementById('salesList');
                salesList.innerHTML = '';

                if (this.salesData.size === 0) {
                    salesList.innerHTML = '<p class="text-muted">No sales created yet.</p>';
                    return;
                }

                // Convert Map to Array and sort by date
                const salesArray = Array.from(this.salesData.values()).sort((a, b) => 
                    new Date(a.saleDate) - new Date(b.saleDate)
                );

                salesArray.forEach((sale, index) => {
                    const saleDiv = document.createElement('div');
                    saleDiv.className = 'border rounded p-3 mb-3';
                    saleDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${sale.saleName}</h6>
                                <p class="mb-1 text-muted">${sale.saleDate} ${sale.location ? '• ' + sale.location : ''}</p>
                                <small class="text-muted">Created: ${new Date(sale.created).toLocaleDateString()}</small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="combiner.renameSale('${sale.saleId}')">
                                    <i class="fas fa-edit"></i> Rename
                                </button>
                                <button class="btn btn-outline-danger" onclick="combiner.deleteSale('${sale.saleId}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                    salesList.appendChild(saleDiv);
                });
            }

            renameSale(saleId) {
                if (!this.salesData.has(saleId)) return;

                const sale = this.salesData.get(saleId);
                this.editingSaleId = saleId;

                // Populate the rename modal
                document.getElementById('editSaleName').value = sale.saleName;
                document.getElementById('editSaleDate').value = sale.saleDate;
                document.getElementById('editSaleLocation').value = sale.location || '';

                // Show rename modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editSalesModal'));
                editModal.hide();
                
                const renameModal = new bootstrap.Modal(document.getElementById('renameSaleModal'));
                renameModal.show();
            }

            async saveSaleChanges() {
                if (!this.editingSaleId) return;

                const saleName = document.getElementById('editSaleName').value.trim();
                const saleDate = document.getElementById('editSaleDate').value;
                const location = document.getElementById('editSaleLocation').value.trim();

                if (!saleName || !saleDate) {
                    alert('Please enter a sale name and date');
                    return;
                }

                // Update the sale info
                const sale = this.salesData.get(this.editingSaleId);
                sale.saleName = saleName;
                sale.saleDate = saleDate;
                sale.location = location;

                await this.saveSalesData();
                this.updateSaleSelector();
                this.updateCurrentSaleInfo();

                // Close rename modal and show edit modal again
                bootstrap.Modal.getInstance(document.getElementById('renameSaleModal')).hide();
                this.showEditSalesModal();

                this.editingSaleId = null;
            }


            async deleteSale(saleId) {
                if (!this.salesData.has(saleId)) return;

                const sale = this.salesData.get(saleId);
                if (!confirm(`Are you sure you want to delete "${sale.saleName}"? This action cannot be undone.`)) {
                    return;
                }

                // If deleting current sale, switch to no sale
                if (this.currentSaleId === saleId) {
                    this.currentSaleId = null;
                    this.resetForNewSale();
                    this.hideWorkingSections();
                }

                this.salesData.delete(saleId);
                await this.saveSalesData();
                this.updateSaleSelector();
                this.updateCurrentSaleInfo();
                this.populateEditSalesModal();
            }


            showWorkingSections() {
                document.getElementById('uploadSection').style.display = 'block';
            }

            hideWorkingSections() {
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('controlsSection').style.display = 'none';
            }

            // Auto-save functionality
            async autoSave() {
                if (this.checkIfSaleFrozen()) {
                    return;
                }
                if (this.currentSaleId) {
                    await this.saveSaleDay(this.currentSaleId);
                }
            }

            handleFiles(fileList) {
                // Provide better feedback for touch devices
                const fileCount = fileList.length;
                if (fileCount > 1) {
                    if (!confirm(`Upload ${fileCount} files?`)) return;
                }
                
                Array.from(fileList).forEach(file => {
                    const isCSV = file.type === 'text/csv' || file.name.endsWith('.csv');
                    const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || 
                                   file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                                   file.type === 'application/vnd.ms-excel';
                    
                    if (isCSV || isExcel) {
                        this.processFile(file);
                    } else {
                        alert(`${file.name} is not a supported file type. Please use CSV or Excel files.`);
                    }
                });
            }

            processFile(file) {
                if (this.checkIfSaleFrozen()) {
                    this.showFrozenError();
                    return;
                }
                const isCSV = file.type === 'text/csv' || file.name.endsWith('.csv');
                const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || 
                               file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                               file.type === 'application/vnd.ms-excel';

                if (isCSV) {
                    this.processCSVFile(file);
                } else if (isExcel) {
                    this.processExcelFile(file);
                }
            }

            processCSVFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        Papa.parse(e.target.result, {
                            header: true,
                            skipEmptyLines: true,
                            transformHeader: (header) => header.trim(),
                            complete: (results) => {
                                if (results.errors.length > 0) {
                                    console.warn('CSV parsing warnings:', results.errors);
                                }
                                
                                const fileData = {
                                    file: file,
                                    fileName: file.name.replace(/\.(csv)$/i, ''),
                                    data: results.data.filter(row => {
                                        // Filter out completely empty rows
                                        return Object.values(row).some(value => 
                                            value && value.toString().trim() !== ''
                                        );
                                    }),
                                    errors: results.errors,
                                    type: 'CSV'
                                };
                                
                                console.log(`Processed ${fileData.fileName}: ${fileData.data.length} rows`);
                                this.askForOwnerName(fileData);
                            },
                            error: (error) => {
                                console.error('Error parsing CSV:', error);
                                alert(`Error parsing ${file.name}: ${error.message}`);
                            }
                        });
                    } catch (error) {
                        console.error('Error reading CSV file:', error);
                        alert(`Error reading ${file.name}: ${error.message}`);
                    }
                };
                reader.onerror = () => {
                    alert(`Error reading file: ${file.name}`);
                };
                reader.readAsText(file);
            }

            processExcelFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Use the first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON with header row
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                            defval: '',
                            blankrows: false
                        });
                        
                        if (jsonData.length === 0) {
                            alert(`${file.name} appears to be empty.`);
                            return;
                        }
                        
                        // Get headers from first row
                        const headers = jsonData[0].map(h => h ? h.toString().trim() : '');
                        const dataRows = jsonData.slice(1);
                        
                        // Convert to object format
                        const processedData = dataRows
                            .filter(row => row.some(cell => cell && cell.toString().trim() !== ''))
                            .map(row => {
                                const obj = {};
                                headers.forEach((header, index) => {
                                    obj[header] = row[index] ? row[index].toString().trim() : '';
                                });
                                return obj;
                            });
                        
                        const fileData = {
                            file: file,
                            fileName: file.name.replace(/\.(xlsx|xls)$/i, ''),
                            data: processedData,
                            errors: [],
                            type: 'Excel',
                            sheet: firstSheetName
                        };
                        
                        console.log(`Processed ${fileData.fileName}: ${fileData.data.length} rows from sheet "${firstSheetName}"`);
                        this.askForOwnerName(fileData);
                        
                    } catch (error) {
                        console.error('Error parsing Excel file:', error);
                        alert(`Error parsing ${file.name}: ${error.message}`);
                    }
                };
                reader.onerror = () => {
                    alert(`Error reading file: ${file.name}`);
                };
                reader.readAsArrayBuffer(file);
            }

            askForOwnerName(fileData) {
                this.pendingFile = fileData;
                document.getElementById('currentFileName').textContent = fileData.fileName;
                document.getElementById('shortlistOwner').value = fileData.fileName; // Default to filename
                const modal = new bootstrap.Modal(document.getElementById('nameModal'));
                modal.show();
                
                // Focus on input and select default text
                setTimeout(() => {
                    const input = document.getElementById('shortlistOwner');
                    input.focus();
                    input.select();
                }, 500);
            }

            saveShortlistName() {
                const ownerName = document.getElementById('shortlistOwner').value.trim();
                if (!ownerName) {
                    alert('Please enter a name for this shortlist');
                    return;
                }

                if (this.pendingFile) {
                    this.pendingFile.owner = ownerName;
                    this.pendingFile.name = ownerName; // Use owner name as display name
                    
                    // Upload to persistent storage if current sale is selected
                    const currentSaleId = document.getElementById('saleSelector').value;
                    if (currentSaleId) {
                        this.uploadFileToPersistentStorage(this.pendingFile, currentSaleId);
                    }
                    
                    this.files.push(this.pendingFile);
                    this.updateFileList();
                    this.updateCombineButton();
                    this.pendingFile = null;
                    this.autoSave(); // Auto-save after adding file
                }

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('nameModal')).hide();
                
                // Clear form
                document.getElementById('shortlistOwner').value = '';
            }

            updateFileList() {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = this.files.map((file, index) => `
                    <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2">
                        <div>
                            <strong>${file.name}</strong> <small class="text-muted">(${file.fileName})</small>
                            <br><small class="text-muted">(${file.data.length} horses${file.type ? `, ${file.type}` : ''}${file.sheet ? `, Sheet: ${file.sheet}` : ''})</small>
                            ${file.errors.length > 0 ? `<span class="badge bg-warning">${file.errors.length} warnings</span>` : ''}
                        </div>
                        <button class="btn btn-sm" onclick="combiner.removeFile(${index})" title="Delete File" style="background-color: transparent; border: 1px solid #ff6600; color: #ff6600;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `).join('');
            }

            async uploadFileToPersistentStorage(fileData, saleId) {
                // File data is already stored in localStorage via saveSalesData()
                // No additional upload needed for GitHub Pages deployment
                console.log(`File ${fileData.name} stored in localStorage for sale ${saleId}`);
            }

            convertDataToCSV(data) {
                if (!data || data.length === 0) return '';
                
                // Get headers from first row
                const headers = Object.keys(data[0]);
                
                // Convert to CSV format
                const csvRows = [headers.join(',')];
                
                for (const row of data) {
                    const values = headers.map(header => {
                        const value = row[header] || '';
                        // Escape quotes and wrap in quotes if contains comma, quote, or newline
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    });
                    csvRows.push(values.join(','));
                }
                
                return csvRows.join('\n');
            }

            removeFile(index) {
                if (this.checkIfSaleFrozen()) {
                    this.showFrozenError();
                    return;
                }
                if (!confirm('Are you sure you want to remove this shortlist file?')) {
                    return;
                }
                this.files.splice(index, 1);
                this.updateFileList();
                this.updateCombineButton();
                this.autoSave(); // Auto-save after removing file
            }

            updateCombineButton() {
                document.getElementById('combineBtn').disabled = this.files.length < 1;
            }

            cleanConsignerText(consigner) {
                if (!consigner) return '';
                
                // Remove various terms and everything after them
                let cleaned = consigner.toString();
                
                // Patterns to match and remove (including everything after)
                const patterns = [
                    /, Agent.*$/i,
                    /, Agency.*$/i,
                    / Agent.*$/i,
                    / Agency.*$/i,
                    /Agent.*$/i,
                    /Agency.*$/i,
                    /, LLC.*$/i,
                    / LLC.*$/i,
                    /LLC.*$/i,
                    /, Sales.*$/i,
                    / Sales.*$/i,
                    /Sales.*$/i,
                    /, Farm.*$/i,
                    / Farm.*$/i,
                    /Farm.*$/i,
                    /, Stud.*$/i,
                    / Stud.*$/i,
                    /Stud.*$/i,
                    / at Xalapa.*$/i,
                    /, at Xalapa.*$/i,
                    /at Xalapa.*$/i,
                    /\(Creastwood\)/gi,
                    /\(Bernard McCormack\)/gi
                ];
                
                for (const pattern of patterns) {
                    cleaned = cleaned.replace(pattern, '');
                }
                
                // Remove specific text patterns in parentheses
                cleaned = cleaned.replace(/\(Francis and Barbara Vanlangendonck\),?/gi, '');
                cleaned = cleaned.replace(/\(Francis and Barbara Vanlangendonck\)/gi, '');
                
                // Replace McLean with Crestwood
                cleaned = cleaned.replace(/McLean/gi, 'Crestwood');
                cleaned = cleaned.replace(/Maclean/gi, 'Crestwood');
                
                return cleaned.trim();
            }

            combineData() {
                if (this.files.length === 0) return;

                // Create a map of all unique horses - preserve existing data if recombining
                const horseMap = new Map();
                
                // If we already have combined data, preserve it
                if (this.combinedData.length > 0) {
                    this.combinedData.forEach(row => {
                        const key = row.Hip || row['Name'] || row['Horse Name'];
                        if (key) {
                            horseMap.set(key, { ...row, shortlists: {} });
                        }
                    });
                }
                
                // First pass: collect all unique horses and their basic info
                this.files.forEach(file => {
                    file.data.forEach(row => {
                        const key = row.Hip || row['Horse Name'] || row['Name'] || Object.values(row)[0];
                        if (!key) return;

                        if (!horseMap.has(key)) {
                            // Store the most complete horse info with permanent columns
                            horseMap.set(key, {
                                Hip: row.Hip || '',
                                'Name': row['Horse Name'] || row['Name'] || '',
                                Sire: row.Sire || '',
                                Dam: row.Dam || '',
                                Sex: row.Sex || '',
                                YOB: row.YOB || '',
                                Consignor: this.cleanConsignerText(row.Consignor || ''),
                                Barn: row.Barn || '',
                                Vet: '', // Permanent column
                                Scope: '', // Permanent column
                                Pinhook: '', // Permanent column
                                Reserve: '', // Permanent column
                                Result: '', // Permanent column
                                shortlists: {}
                            });
                        } else {
                            // Update with non-empty values (but preserve permanent columns)
                            const existing = horseMap.get(key);
                            Object.keys(row).forEach(col => {
                                if (row[col] && row[col].toString().trim() !== '' && 
                                    col !== 'Selection' && col !== 'Comment' &&
                                    !['Vet', 'Scope', 'Pinhook', 'Reserve', 'Result'].includes(col)) {
                                    if (col === 'Consignor') {
                                        existing[col] = this.cleanConsignerText(row[col]);
                                    } else {
                                        existing[col] = row[col];
                                    }
                                }
                            });
                        }
                    });
                });

                // Second pass: add shortlist ratings
                this.files.forEach(file => {
                    file.data.forEach(row => {
                        const key = row.Hip || row['Horse Name'] || row['Name'] || Object.values(row)[0];
                        if (!key || !horseMap.has(key)) return;

                        const horse = horseMap.get(key);
                        const rating = row.Selection || row.Rating || row.Grade || '';
                        // If horse is on this person's shortlist, show rating or "X" if no rating
                        horse.shortlists[file.name] = rating || 'X';
                    });
                });

                // Convert to array format
                this.combinedData = Array.from(horseMap.values()).map(horse => {
                    const row = { ...horse };
                    delete row.shortlists;
                    
                    // Add each person's rating as a column
                    this.files.forEach(file => {
                        row[file.name] = horse.shortlists[file.name] || '';
                    });
                    
                    // Calculate overlap count (including "X" marks)
                    const ratingCount = Object.values(horse.shortlists).filter(r => r && r.toString().trim() !== '').length;
                    row['Overlap'] = ratingCount;
                    
                    return row;
                });

                // Set default sort state
                this.sortState = { column: 'Overlap', direction: 'desc' };

                this.createTable();
                this.updateStats();
                this.showResults();
                this.autoSave(); // Auto-save after combining data
            }

            createTable() {
                const tableHead = document.querySelector('#mainTable thead');
                const tableBody = document.querySelector('#mainTable tbody');

                if (this.combinedData.length === 0) return;

                // Define column order: basic horse info, then Pinhook, shortlists, Scope, Vet, Reserve, Result, overlap count
                const basicColumns = ['Hip', 'Name', 'Sire', 'Dam', 'Sex', 'YOB', 'Consignor'];
                const shortlistColumns = this.files.map(f => f.name);
                const trailingColumns = ['Scope', 'Vet', 'Reserve', 'Result'];
                const metaColumns = ['Overlap'];
                
                // Initialize column order if not set or if we need to add new columns
                if (this.columnOrder.length === 0) {
                    this.columnOrder = [...basicColumns, 'Pinhook', ...shortlistColumns, ...trailingColumns, ...metaColumns, ...this.customColumns];
                } else {
                    // Add Pinhook if missing (should be after basic columns)
                    if (!this.columnOrder.includes('Pinhook')) {
                        const insertIndex = basicColumns.length;
                        this.columnOrder.splice(insertIndex, 0, 'Pinhook');
                    }
                    
                    // Add any new shortlist columns (after Pinhook)
                    shortlistColumns.forEach(col => {
                        if (!this.columnOrder.includes(col)) {
                            const pinhookIndex = this.columnOrder.indexOf('Pinhook');
                            this.columnOrder.splice(pinhookIndex + 1, 0, col);
                        }
                    });
                    
                    // Add trailing columns if missing
                    trailingColumns.forEach(col => {
                        if (!this.columnOrder.includes(col)) {
                            const overlapIndex = this.columnOrder.indexOf('Overlap');
                            this.columnOrder.splice(overlapIndex, 0, col);
                        }
                    });
                }
                
                // Always hide Barn column
                this.hiddenColumns.add('Barn');
                
                // Apply current column order and filter hidden columns
                const visibleColumns = this.columnOrder.filter(col => !this.hiddenColumns.has(col));
                
                // Create header with sorting and drag-drop, plus delete column
                const headerRow = visibleColumns.map(col => {
                    let headerClass = 'sortable-header';
                    if (shortlistColumns.includes(col)) {
                        headerClass += ' shortlist-header';
                    }
                    
                    const sortIcon = this.getSortIcon(col);
                    
                    return `<th class="${headerClass}" data-column="${col}" draggable="true">
                        ${col}
                        <span class="sort-icon ${this.sortState.column === col ? 'active' : ''}">${sortIcon}</span>
                    </th>`;
                }).join('') + '<th class="text-center">Delete</th>';
                
                // Create filter row if visible
                const filterRow = this.filtersVisible ? `
                    <tr class="filter-row">
                        ${visibleColumns.map(col => `
                            <th>
                                <input type="text" class="filter-input" placeholder="Filter ${col}" 
                                       data-column="${col}" value="${this.filters[col] || ''}">
                            </th>
                        `).join('')}
                        <th></th>
                    </tr>
                ` : '';
                
                tableHead.innerHTML = `
                    <tr class="header-row">${headerRow}</tr>
                    ${filterRow}
                `;

                // Apply current filters and sorting
                let filteredData = this.applyFilters(this.combinedData);
                filteredData = this.applySorting(filteredData);

                // Create body
                tableBody.innerHTML = filteredData.map((row, rowIndex) => `
                    <tr>
                        ${visibleColumns.map(col => {
                            let cellContent = row[col] || '';
                            const originalValue = cellContent; // Store original value
                            let cellClass = 'editable-cell';
                            
                            // Style based on column type
                            if (col === 'Hip') {
                                cellClass += ' hip-column';
                            } else if (['Name', 'Sire', 'Dam', 'Consignor'].includes(col)) {
                                cellClass += ' horse-info';
                            } else if (['Vet', 'Scope', 'Pinhook', 'Reserve', 'Result'].includes(col)) {
                                // These are already editable via the base class
                            } else if (shortlistColumns.includes(col) || this.customColumns.includes(col)) {
                                cellClass += ' grade-cell';
                                // Add grade-specific styling
                                const grade = cellContent.toString().toUpperCase();
                                if (grade.includes('A+') || grade.includes('A PLUS')) {
                                    cellClass += ' grade-A-plus';
                                } else if (grade.includes('A')) {
                                    cellClass += ' grade-A';
                                } else if (grade.includes('B+') || grade.includes('B PLUS')) {
                                    cellClass += ' grade-B-plus';
                                } else if (grade.includes('B')) {
                                    cellClass += ' grade-B';
                                } else if (grade.includes('C')) {
                                    cellClass += ' grade-C';
                                } else if (grade.includes('D')) {
                                    cellClass += ' grade-D';
                                }
                            } else if (col === 'Overlap') {
                                const count = parseInt(cellContent);
                                cellContent = count > 1 ? `<strong>${count}</strong>` : '';
                                cellClass = ''; // Not editable
                            }

                            return `<td class="${cellClass}" data-column="${col}" data-original-value="${originalValue}">${cellContent}</td>`;
                        }).join('')}
                        <td class="text-center">
                            <button class="btn btn-sm btn-primary delete-horse-btn" data-row-index="${rowIndex}" title="Delete this horse">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Setup all event listeners
                this.setupTableEventListeners();
                this.setupColumnControls();
                this.setupCellEditing();
            }

            getSortIcon(column) {
                if (this.sortState.column === column) {
                    return this.sortState.direction === 'asc' ? '▲' : '▼';
                }
                return '↕';
            }

            applyFilters(data) {
                return data.filter(row => {
                    return Object.keys(this.filters).every(column => {
                        const filterValue = this.filters[column].toLowerCase();
                        if (!filterValue) return true;
                        const cellValue = (row[column] || '').toString().toLowerCase();
                        return cellValue.includes(filterValue);
                    });
                });
            }

            applySorting(data) {
                if (!this.sortState.column) return data;
                
                return [...data].sort((a, b) => {
                    let aVal = a[this.sortState.column] || '';
                    let bVal = b[this.sortState.column] || '';
                    
                    // Handle numeric columns
                    if (this.sortState.column === 'Hip' || this.sortState.column === 'Overlap' || this.sortState.column === 'YOB') {
                        aVal = parseInt(aVal) || 0;
                        bVal = parseInt(bVal) || 0;
                    } else {
                        aVal = aVal.toString().toLowerCase();
                        bVal = bVal.toString().toLowerCase();
                    }
                    
                    if (aVal < bVal) return this.sortState.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return this.sortState.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            setupTableEventListeners() {
                // Header click for sorting
                $('#mainTable thead').off('click').on('click', '.sortable-header', (e) => {
                    const column = $(e.currentTarget).data('column');
                    this.handleSort(column);
                });

                // Filter input events with debouncing
                let filterTimeout;
                $('#mainTable thead').off('input').on('input', '.filter-input', (e) => {
                    const column = $(e.target).data('column');
                    const value = e.target.value;
                    this.filters[column] = value;
                    
                    // Debounce table recreation
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(() => {
                        this.createTable(); // Refresh table with new filters
                        this.autoSave(); // Auto-save after changing filters
                    }, 300);
                });

                // Delete horse button event
                $('#mainTable tbody').off('click', '.delete-horse-btn').on('click', '.delete-horse-btn', (e) => {
                    e.stopPropagation();
                    const rowIndex = parseInt($(e.currentTarget).data('row-index'));
                    this.deleteHorse(rowIndex);
                });

                // Drag and drop for column reordering
                this.setupDragAndDrop();
            }

            setupDragAndDrop() {
                let draggedColumn = null;

                $('#mainTable thead th').off('dragstart dragover drop').on({
                    dragstart: (e) => {
                        draggedColumn = $(e.currentTarget).data('column');
                        $(e.currentTarget).addClass('dragging');
                    },
                    dragend: (e) => {
                        $(e.currentTarget).removeClass('dragging');
                        $('.drop-indicator').remove();
                    },
                    dragover: (e) => {
                        e.preventDefault();
                        const targetColumn = $(e.currentTarget).data('column');
                        if (draggedColumn !== targetColumn) {
                            // Visual feedback for drop position
                            $('.drop-indicator').remove();
                            const indicator = $('<div class="drop-indicator"></div>');
                            $(e.currentTarget).before(indicator);
                        }
                    },
                    drop: (e) => {
                        e.preventDefault();
                        const targetColumn = $(e.currentTarget).data('column');
                        if (draggedColumn && draggedColumn !== targetColumn) {
                            this.reorderColumns(draggedColumn, targetColumn);
                        }
                        $('.drop-indicator').remove();
                    }
                });
            }

            setupColumnControls() {
                // Generate column checkboxes
                const checkboxContainer = document.getElementById('columnCheckboxes');
                const reorderSelect = document.getElementById('columnReorder');
                
                checkboxContainer.innerHTML = '';
                reorderSelect.innerHTML = '<option value="">Select column to move...</option>';
                
                this.columnOrder.forEach(col => {
                    // Checkbox for show/hide
                    const checkbox = document.createElement('div');
                    checkbox.className = 'column-checkbox';
                    checkbox.innerHTML = `
                        <label>
                            <input type="checkbox" ${this.hiddenColumns.has(col) ? '' : 'checked'} 
                                   data-column="${col}">
                            ${col}
                        </label>
                    `;
                    checkboxContainer.appendChild(checkbox);
                    
                    // Option for reorder select
                    const option = document.createElement('option');
                    option.value = col;
                    option.textContent = col;
                    reorderSelect.appendChild(option);
                });

                // Add event listeners for checkboxes with debouncing
                let debounceTimeout;
                checkboxContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        const column = e.target.dataset.column;
                        if (e.target.checked) {
                            this.hiddenColumns.delete(column);
                        } else {
                            this.hiddenColumns.add(column);
                        }
                        
                        // Debounce table recreation for better performance
                        clearTimeout(debounceTimeout);
                        debounceTimeout = setTimeout(() => {
                            this.createTable();
                            this.autoSave();
                        }, 150);
                    }
                });
            }

            handleSort(column) {
                if (this.sortState.column === column) {
                    this.sortState.direction = this.sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortState.column = column;
                    this.sortState.direction = 'asc';
                }
                this.createTable();
                this.autoSave(); // Auto-save after sorting
            }

            reorderColumns(draggedCol, targetCol) {
                const draggedIndex = this.columnOrder.indexOf(draggedCol);
                const targetIndex = this.columnOrder.indexOf(targetCol);
                
                // Remove dragged column and insert at target position
                this.columnOrder.splice(draggedIndex, 1);
                this.columnOrder.splice(targetIndex, 0, draggedCol);
                
                this.createTable();
                this.setupColumnControls();
                this.autoSave(); // Auto-save after reordering columns
            }

            selectAllColumns() {
                this.hiddenColumns.clear();
                this.createTable();
                this.setupColumnControls();
                this.autoSave(); // Auto-save after selecting all columns
            }

            deselectAllColumns() {
                this.columnOrder.forEach(col => this.hiddenColumns.add(col));
                // Keep at least Hip and Horse Name visible
                this.hiddenColumns.delete('Hip');
                this.hiddenColumns.delete('Horse Name');
                this.createTable();
                this.setupColumnControls();
                this.autoSave(); // Auto-save after deselecting all columns
            }

            resetColumnLayout() {
                const basicColumns = ['Hip', 'Name', 'Sire', 'Dam', 'Sex', 'YOB', 'Consignor'];
                const shortlistColumns = this.files.map(f => f.name);
                const trailingColumns = ['Scope', 'Vet', 'Reserve', 'Result'];
                const metaColumns = ['Overlap'];
                
                this.columnOrder = [...basicColumns, 'Pinhook', ...shortlistColumns, ...trailingColumns, ...metaColumns, ...this.customColumns];
                this.hiddenColumns.clear();
                this.hiddenColumns.add('Barn'); // Always hide Barn
                this.sortState = { column: 'Overlap', direction: 'desc' };
                this.filters = {};
                
                this.createTable();
                this.setupColumnControls();
                this.autoSave(); // Auto-save after resetting column layout
            }

            toggleFilters() {
                this.filtersVisible = !this.filtersVisible;
                this.createTable();
                
                const btn = document.getElementById('toggleFiltersBtn');
                btn.innerHTML = this.filtersVisible ? 
                    '<i class="fas fa-filter"></i> Hide' : 
                    '<i class="fas fa-filter"></i> Filters';
            }

            clearAllFilters() {
                this.filters = {};
                this.createTable();
                this.autoSave();
            }

            moveColumn(direction) {
                const select = document.getElementById('columnReorder');
                const selectedColumn = select.value;
                if (!selectedColumn) return;
                
                const currentIndex = this.columnOrder.indexOf(selectedColumn);
                const newIndex = direction === 'left' ? Math.max(0, currentIndex - 1) : Math.min(this.columnOrder.length - 1, currentIndex + 1);
                
                if (newIndex !== currentIndex) {
                    this.columnOrder.splice(currentIndex, 1);
                    this.columnOrder.splice(newIndex, 0, selectedColumn);
                    this.createTable();
                    this.setupColumnControls();
                    select.value = selectedColumn; // Maintain selection
                    this.autoSave(); // Auto-save after moving column
                }
            }

            cancelAllEdits() {
                // Find all editing cells and cancel them immediately
                $('.editing').each(function() {
                    const $cell = $(this);
                    const originalValue = $cell.data('original-value') || '';
                    $cell.removeClass('editing').text(originalValue);
                });
            }

            setupCellEditing() {
                const shortlistColumns = this.files.map(f => f.name);
                
                // Remove any existing event listeners to prevent conflicts
                $('#mainTable tbody').off('click', '.editable-cell');
                
                // Use event delegation for better performance
                $('#mainTable tbody').on('click', '.editable-cell', (e) => {
                    const cell = $(e.target);
                    
                    // Skip if already editing
                    if (cell.hasClass('editing')) return;

                    // Check if sale is frozen
                    if (this.checkIfSaleFrozen()) {
                        this.showFrozenError();
                        return;
                    }

                    // Cancel ALL existing edits immediately
                    this.cancelAllEdits();

                    const currentValue = cell.data('original-value') || '';
                    const column = cell.data('column');
                    
                    // Don't allow editing of non-editable columns
                    if (column === 'Overlap') return;
                    
                    cell.addClass('editing');
                    
                    // Create appropriate input based on column type
                    let input;
                    if (column === 'Vet' || column === 'Scope') {
                        // Text input for Vet and Scope columns
                        input = $(`<input type="text" class="edit-input" value="${currentValue}">`);
                    } else if (shortlistColumns.includes(column)) {
                        // Dropdown for grades (shortlist columns only)
                        input = $(`
                            <select class="edit-select">
                                <option value="">Select Grade</option>
                                <option value="A+" ${currentValue === 'A+' ? 'selected' : ''}>A+</option>
                                <option value="A" ${currentValue === 'A' ? 'selected' : ''}>A</option>
                                <option value="B+" ${currentValue === 'B+' ? 'selected' : ''}>B+</option>
                                <option value="B" ${currentValue === 'B' ? 'selected' : ''}>B</option>
                                <option value="C" ${currentValue === 'C' ? 'selected' : ''}>C</option>
                                <option value="D" ${currentValue === 'D' ? 'selected' : ''}>D</option>
                                <option value="Custom">Custom...</option>
                            </select>
                        `);
                    } else {
                        // Text input for other columns
                        input = $(`<input type="text" class="edit-input" value="${currentValue}">`);
                    }
                    
                    // Store original value for cancel functionality
                    input.data('original-value', currentValue);
                    
                    cell.html(input);
                    input.focus();
                    if (input.is('input')) input.select();
                    

                    const saveEdit = (newValue) => {
                        // Handle special formatting for Reserve column
                        if (column === 'Reserve' && newValue && !newValue.startsWith('$')) {
                            newValue = '$' + newValue;
                        }
                        
                        // Update the original data
                        const rowIndex = cell.closest('tr').index();
                        const visibleColumns = this.columnOrder.filter(col => !this.hiddenColumns.has(col));
                        const dataIndex = this.getDataIndexFromRowIndex(rowIndex);
                        
                        if (dataIndex >= 0) {
                            this.combinedData[dataIndex][column] = newValue;
                        }
                        
                        // Update stats immediately if Vet or Result column was edited
                        if (column === 'Vet') {
                            this.updateVettingStat();
                        }
                        if (column === 'Result') {
                            this.updatePurchasedStat();
                        }
                        
                        // Refresh the table to apply styling
                        this.createTable();
                        this.autoSave(); // Auto-save after cell edit
                    };

                    const cancelEdit = () => {
                        cell.removeClass('editing').text(currentValue);
                    };

                    if (input.is('select')) {
                        input.on('change', (e) => {
                            const selectedValue = e.target.value;
                            if (selectedValue === 'Custom') {
                                const customValue = prompt('Enter custom grade:', currentValue);
                                if (customValue !== null) {
                                    saveEdit(customValue);
                                } else {
                                    cancelEdit();
                                }
                            } else {
                                saveEdit(selectedValue);
                            }
                        });
                        input.on('blur', cancelEdit);
                    } else {
                        input.on('blur keypress touchend', (e) => {
                            if (e.type === 'blur' || e.which === 13 || e.type === 'touchend') {
                                saveEdit(input.val());
                            } else if (e.which === 27) { // Escape key
                                cancelEdit();
                            }
                        });
                        
                        // Better touch handling for mobile/iPad
                        input.on('focus', () => {
                            // Prevent the page from scrolling when input is focused on iOS
                            setTimeout(() => {
                                input[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 300);
                        });
                    }
                });
            }

            getDataIndexFromRowIndex(rowIndex) {
                // This is a simplified mapping - in a more complex scenario, 
                // you'd need to track the mapping between filtered/sorted rows and original data
                let filteredData = this.applyFilters(this.combinedData);
                filteredData = this.applySorting(filteredData);
                
                if (rowIndex < filteredData.length) {
                    const rowData = filteredData[rowIndex];
                    return this.combinedData.findIndex(row => 
                        row.Hip === rowData.Hip && (row['Name'] === rowData['Name'] || row['Horse Name'] === rowData['Horse Name'])
                    );
                }
                return -1;
            }

            updateStats() {
                const total = this.combinedData.length;
                const overlapping = this.combinedData.filter(row => row['Overlap'] > 1).length;
                
                // Count purchased horses (any horse with "Repole" in Result column)
                const purchased = this.combinedData.filter(row => 
                    row.Result && row.Result.toString().toLowerCase().includes('repole')
                ).length;
                
                // Count colts and fillies
                const colts = this.combinedData.filter(row => 
                    row.Sex && (row.Sex.toUpperCase() === 'C' || row.Sex.toUpperCase() === 'COLT')
                ).length;
                const fillies = this.combinedData.filter(row => 
                    row.Sex && (row.Sex.toUpperCase() === 'F' || row.Sex.toUpperCase() === 'FILLY')
                ).length;
                
                // Count horses with Y in vet column
                const vetting = this.combinedData.filter(row => 
                    row.Vet && row.Vet.toString().trim() !== ''
                ).length;

                document.getElementById('purchasedCount').textContent = purchased;
                document.getElementById('uniqueHorses').textContent = total;
                document.getElementById('coltCount').textContent = colts;
                document.getElementById('fillyCount').textContent = fillies;
                document.getElementById('vettingCount').textContent = vetting;
                document.getElementById('overlappingHorses').textContent = overlapping;
                document.getElementById('shortlistCount').textContent = this.files.length;
            }

            updateVettingStat() {
                const vetting = this.combinedData.filter(row => 
                    row.Vet && row.Vet.toString().trim() !== ''
                ).length;
                document.getElementById('vettingCount').textContent = vetting;
            }

            updatePurchasedStat() {
                const purchased = this.combinedData.filter(row => 
                    row.Result && row.Result.toString().toLowerCase().includes('repole')
                ).length;
                document.getElementById('purchasedCount').textContent = purchased;
            }

            deleteHorse(filteredRowIndex) {
                if (!confirm('Are you sure you want to delete this horse from the shortlist?')) {
                    return;
                }

                // Get the filtered and sorted data to find the correct horse
                let filteredData = this.applyFilters(this.combinedData);
                filteredData = this.applySorting(filteredData);

                if (filteredRowIndex < filteredData.length) {
                    const rowToDelete = filteredData[filteredRowIndex];
                    
                    // Find the horse in the original data array using Hip and Name
                    const originalIndex = this.combinedData.findIndex(row => 
                        row.Hip === rowToDelete.Hip && 
                        (row['Name'] === rowToDelete['Name'] || row['Horse Name'] === rowToDelete['Horse Name'])
                    );

                    if (originalIndex >= 0) {
                        // Remove the horse from combinedData
                        this.combinedData.splice(originalIndex, 1);
                        
                        // Update statistics and refresh table
                        this.updateStatistics();
                        this.createTable();
                        this.autoSave();
                    }
                }
            }

            showResults() {
                document.getElementById('statsSection').style.display = 'block';
                document.getElementById('controlsSection').style.display = 'block';
            }

            exportCSV() {
                if (this.combinedData.length === 0) return;

                // Get current sale info for title
                const saleInfo = this.currentSaleId ? this.salesData.get(this.currentSaleId) : null;
                const saleTitle = saleInfo ? saleInfo.saleName : 'Combined Shortlist';

                // Get only visible columns
                const visibleColumns = this.columnOrder.filter(col => !this.hiddenColumns.has(col));
                
                // Filter data to only include visible columns
                const exportData = this.combinedData.map(row => {
                    const filteredRow = {};
                    visibleColumns.forEach(col => {
                        filteredRow[col] = row[col] || '';
                    });
                    return filteredRow;
                });

                // Add title row at the top
                const titleRow = {};
                visibleColumns.forEach((col, index) => {
                    titleRow[col] = index === 0 ? saleTitle : '';
                });
                
                // Add empty row for spacing
                const emptyRow = {};
                visibleColumns.forEach(col => {
                    emptyRow[col] = '';
                });

                // Create CSV with custom header structure
                const csvRows = [];
                
                // Add title as first row
                csvRows.push([saleTitle, ...new Array(visibleColumns.length - 1).fill('')]);
                
                // Add empty row for spacing
                csvRows.push(new Array(visibleColumns.length).fill(''));
                
                // Add column headers
                csvRows.push(visibleColumns);
                
                // Add data rows
                exportData.forEach(row => {
                    csvRows.push(visibleColumns.map(col => row[col] || ''));
                });
                
                const csv = csvRows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${saleTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_shortlist.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            exportPDF() {
                if (this.combinedData.length === 0) return;

                // Get current sale info for title
                const saleInfo = this.currentSaleId ? this.salesData.get(this.currentSaleId) : null;
                const saleTitle = saleInfo ? `${saleInfo.saleName} - ${saleInfo.saleDate}` : 'Combined Shortlist';

                // Get only visible columns and data
                const visibleColumns = this.columnOrder.filter(col => !this.hiddenColumns.has(col));
                const exportData = this.combinedData.map(row => {
                    const filteredRow = {};
                    visibleColumns.forEach(col => {
                        filteredRow[col] = row[col] || '';
                    });
                    return filteredRow;
                });

                // Calculate optimal column widths based on content
                const calculateColumnWidth = (col) => {
                    // Find the longest content in this column
                    let maxLength = col.length; // Start with header length
                    
                    exportData.forEach(row => {
                        const cellValue = (row[col] || '').toString();
                        maxLength = Math.max(maxLength, cellValue.length);
                    });
                    
                    // Convert character count to approximate points (8 points per character)
                    return Math.min(Math.max(maxLength * 8, 30), 150); // Min 30, max 150 points
                };

                // Get dynamic column widths
                const columnWidths = visibleColumns.map(col => calculateColumnWidth(col));
                const totalWidth = columnWidths.reduce((sum, width) => sum + width, 0);
                
                // Scale to fit page width (A3 landscape = ~1050 points with margins)
                const maxWidth = 1050;
                const scaleFactor = Math.min(1, maxWidth / totalWidth);
                const finalWidths = columnWidths.map(width => Math.floor(width * scaleFactor));

                // Function to wrap text for better display
                const wrapText = (text, maxLength = 25) => {
                    if (!text) return '';
                    const str = text.toString();
                    if (str.length <= maxLength) return str;
                    
                    const words = str.split(' ');
                    const lines = [];
                    let currentLine = '';
                    
                    for (const word of words) {
                        if ((currentLine + ' ' + word).length <= maxLength) {
                            currentLine += (currentLine ? ' ' : '') + word;
                        } else {
                            if (currentLine) lines.push(currentLine);
                            currentLine = word;
                        }
                    }
                    if (currentLine) lines.push(currentLine);
                    
                    return lines.join('\n');
                };

                // Create table body with proper formatting and text wrapping
                const tableBody = [
                    // Header row
                    visibleColumns.map(col => ({
                        text: col,
                        style: 'tableHeader',
                        fillColor: '#e8e8e8',
                        alignment: 'center'
                    })),
                    // Data rows
                    ...exportData.map(row => 
                        visibleColumns.map((col, colIndex) => {
                            let cellValue = row[col] || '';
                            
                            // Calculate max length based on column width
                            let maxLength = Math.floor(finalWidths[colIndex] / 8);
                            
                            // Adjust max length for specific columns
                            if (['Hip', 'Sex', 'YOB', 'Vet', 'Scope'].includes(col)) {
                                maxLength = Math.min(maxLength, 8);
                            } else if (['Name', 'Sire', 'Dam', 'Consignor'].includes(col)) {
                                maxLength = Math.max(maxLength, 15);
                            }
                            
                            return {
                                text: wrapText(cellValue, maxLength),
                                style: 'tableCell',
                                alignment: 'center'
                            };
                        })
                    )
                ];

                const docDefinition = {
                    content: [
                        { 
                            text: saleTitle, 
                            style: 'title' 
                        },
                        { 
                            text: `${exportData.length} horses | ${this.files.length} shortlists`, 
                            style: 'subtitle' 
                        },
                        {
                            table: {
                                headerRows: 1,
                                widths: finalWidths,
                                body: tableBody,
                                dontBreakRows: false
                            },
                            layout: {
                                fillColor: function (rowIndex, node, columnIndex) {
                                    return (rowIndex === 0) ? '#e8e8e8' : ((rowIndex % 2 === 0) ? '#f9f9f9' : null);
                                },
                                hLineWidth: function (i, node) {
                                    return (i === 0 || i === 1 || i === node.table.body.length) ? 2 : 1;
                                },
                                vLineWidth: function (i, node) {
                                    return 1;
                                },
                                hLineColor: function (i, node) {
                                    return '#000';
                                },
                                vLineColor: function (i, node) {
                                    return '#000';
                                },
                                paddingLeft: function(i, node) { return 6; },
                                paddingRight: function(i, node) { return 6; },
                                paddingTop: function(i, node) { return 8; },
                                paddingBottom: function(i, node) { return 8; }
                            }
                        }
                    ],
                    styles: {
                        title: { 
                            fontSize: 20, 
                            bold: true, 
                            alignment: 'center',
                            margin: [0, 10, 0, 15] 
                        },
                        subtitle: { 
                            fontSize: 12, 
                            alignment: 'center',
                            margin: [0, 0, 0, 20],
                            color: '#666'
                        },
                        tableHeader: { 
                            fontSize: 12, 
                            bold: true, 
                            alignment: 'center'
                        },
                        tableCell: { 
                            fontSize: 11, 
                            alignment: 'center'
                        }
                    },
                    pageOrientation: 'landscape',
                    pageSize: 'A3',
                    pageMargins: [20, 30, 20, 30]
                };

                const filename = `${saleTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_shortlist.pdf`;
                pdfMake.createPdf(docDefinition).download(filename);
            }

            showAddColumnModal() {
                const modal = new bootstrap.Modal(document.getElementById('addColumnModal'));
                modal.show();
            }

            addCustomColumn() {
                if (this.checkIfSaleFrozen()) {
                    this.showFrozenError();
                    return;
                }
                const name = document.getElementById('columnName').value.trim();
                const type = document.getElementById('columnType').value;
                
                if (!name) {
                    alert('Please enter a column name');
                    return;
                }

                if (this.columnOrder.includes(name)) {
                    alert('Column already exists');
                    return;
                }

                // Add column to data
                this.combinedData.forEach(row => {
                    row[name] = '';
                });

                this.customColumns.push(name);
                this.columnOrder.push(name);
                this.createTable();
                this.setupColumnControls();
                this.autoSave(); // Auto-save after adding custom column

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addColumnModal')).hide();
                
                // Clear form
                document.getElementById('columnName').value = '';
                document.getElementById('columnType').value = 'text';
            }

            generateShareLink() {
                const data = {
                    files: this.files.map(f => ({ name: f.name, data: f.data })),
                    customColumns: this.customColumns
                };
                
                const compressed = btoa(JSON.stringify(data));
                const shareUrl = `${window.location.href.split('?')[0]}?data=${compressed}`;
                
                document.getElementById('shareLink').value = shareUrl;
                const modal = new bootstrap.Modal(document.getElementById('shareModal'));
                modal.show();
            }

            copyShareLink() {
                const shareLink = document.getElementById('shareLink');
                shareLink.select();
                document.execCommand('copy');
                
                const btn = document.getElementById('copyLinkBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = originalText, 2000);
            }

            loadFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const data = urlParams.get('data');
                
                if (data) {
                    try {
                        const parsed = JSON.parse(atob(data));
                        this.files = parsed.files || [];
                        this.customColumns = parsed.customColumns || [];
                        
                        if (this.files.length > 0) {
                            this.updateFileList();
                            this.updateCombineButton();
                            this.combineData();
                        }
                    } catch (e) {
                        console.error('Error loading shared data:', e);
                    }
                }
            }

            clearAll() {
                this.files = [];
                this.combinedData = [];
                this.customColumns = [];
                
                if (this.table) {
                    this.table.destroy();
                    this.table = null;
                }
                
                document.getElementById('fileList').innerHTML = '';
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('controlsSection').style.display = 'none';
                document.querySelector('#mainTable thead').innerHTML = '';
                document.querySelector('#mainTable tbody').innerHTML = '';
                
                this.updateCombineButton();
            }

            // ========== ADMIN FUNCTIONALITY ==========

            addAdminButton() {
                // Add hidden admin button to page - only visible on specific key combo
                const adminBtn = document.createElement('button');
                adminBtn.id = 'hiddenAdminBtn';
                adminBtn.innerHTML = 'Admin';
                adminBtn.className = 'btn btn-sm btn-secondary';
                adminBtn.style.position = 'fixed';
                adminBtn.style.bottom = '10px';
                adminBtn.style.right = '10px';
                adminBtn.style.display = 'none';
                adminBtn.style.zIndex = '9999';
                adminBtn.addEventListener('click', () => this.showPinModal());
                document.body.appendChild(adminBtn);

                // Show admin button on Ctrl+Shift+A
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                        adminBtn.style.display = adminBtn.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }

            showPinModal() {
                document.getElementById('adminPin').value = '';
                document.getElementById('pinError').style.display = 'none';
                const modal = new bootstrap.Modal(document.getElementById('pinModal'));
                modal.show();
            }

            verifyPin() {
                const enteredPin = document.getElementById('adminPin').value;
                if (enteredPin === this.ADMIN_PIN) {
                    this.isAdmin = true;
                    this.startAdminSession();
                    bootstrap.Modal.getInstance(document.getElementById('pinModal')).hide();
                    this.showAdminPanel();
                } else {
                    document.getElementById('pinError').style.display = 'block';
                    document.getElementById('adminPin').value = '';
                }
            }

            startAdminSession() {
                // Clear any existing timeout
                if (this.adminSessionTimeout) {
                    clearTimeout(this.adminSessionTimeout);
                }

                // Set new timeout
                this.adminSessionTimeout = setTimeout(() => {
                    this.exitAdminMode();
                }, this.ADMIN_TIMEOUT);

                // Store admin status (temporary, will expire)
                localStorage.setItem('admin_session', Date.now().toString());
            }

            exitAdminMode() {
                this.isAdmin = false;
                if (this.adminSessionTimeout) {
                    clearTimeout(this.adminSessionTimeout);
                    this.adminSessionTimeout = null;
                }
                localStorage.removeItem('admin_session');
                
                // Close any open admin modals
                const adminModal = bootstrap.Modal.getInstance(document.getElementById('adminPanelModal'));
                if (adminModal) {
                    adminModal.hide();
                }

                // Update UI to reflect non-admin state
                this.updateSaleSelector();
            }

            showAdminPanel() {
                this.populateAdminSalesList();
                const modal = new bootstrap.Modal(document.getElementById('adminPanelModal'));
                modal.show();
            }

            populateAdminSalesList() {
                const container = document.getElementById('adminSalesList');
                container.innerHTML = '';

                if (this.salesData.size === 0) {
                    container.innerHTML = '<p class="text-muted">No sales created yet</p>';
                    return;
                }

                this.salesData.forEach((saleInfo, saleId) => {
                    const isFrozen = this.isSaleFrozen(saleId);
                    const div = document.createElement('div');
                    div.className = 'border rounded p-3 mb-2';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${saleInfo.saleName}</strong>
                                <small class="text-muted d-block">${saleInfo.saleDate} - ${saleInfo.location || 'No location'}</small>
                            </div>
                            <div class="d-flex gap-2">
                                <span class="badge ${isFrozen ? 'bg-danger' : 'bg-success'}">${isFrozen ? 'FROZEN' : 'Active'}</span>
                                <button class="btn btn-sm ${isFrozen ? 'btn-success' : 'btn-warning'}" onclick="combiner.toggleSaleFreeze('${saleId}')">
                                    ${isFrozen ? 'Unfreeze' : 'Freeze'}
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="combiner.deleteSaleAsAdmin('${saleId}')">Delete</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            isSaleFrozen(saleId) {
                if (!this.salesData.has(saleId)) return false;
                const saleInfo = this.salesData.get(saleId);
                return saleInfo.frozen || false;
            }

            async toggleSaleFreeze(saleId) {
                if (!this.salesData.has(saleId)) return;
                
                const saleInfo = this.salesData.get(saleId);
                saleInfo.frozen = !saleInfo.frozen;
                this.salesData.set(saleId, saleInfo);
                
                await this.saveSalesData();
                this.populateAdminSalesList();
            }

            deleteSaleAsAdmin(saleId) {
                if (!this.isAdmin) return;
                
                if (confirm('Are you sure you want to permanently delete this sale? This cannot be undone.')) {
                    this.salesData.delete(saleId);
                    this.saveSalesData();
                    
                    // Remove from frozen list if it was frozen
                    const frozenSales = JSON.parse(localStorage.getItem('frozen_sales') || '[]');
                    const index = frozenSales.indexOf(saleId);
                    if (index > -1) {
                        frozenSales.splice(index, 1);
                        localStorage.setItem('frozen_sales', JSON.stringify(frozenSales));
                    }
                    
                    // If this was the current sale, reset
                    if (this.currentSaleId === saleId) {
                        this.currentSaleId = null;
                        this.resetForNewSale();
                    }
                    
                    this.updateSaleSelector();
                    this.populateAdminSalesList();
                }
            }

            checkIfSaleFrozen() {
                if (!this.currentSaleId) return false;
                return this.isSaleFrozen(this.currentSaleId);
            }

            showFrozenError() {
                alert('Unable to save changes. Please try again later.');
            }

            // ========== ADMIN FUNCTIONALITY ==========
            
            addAdminButton() {
                // Add hidden LOST numbers button as easter egg
                const adminBtn = document.createElement('button');
                adminBtn.id = 'hiddenAdminBtn';
                adminBtn.innerHTML = '>: 4 8 15 16 23';
                adminBtn.style.position = 'fixed';
                adminBtn.style.bottom = '10px';
                adminBtn.style.right = '10px';
                adminBtn.style.display = 'none';
                adminBtn.style.zIndex = '9999';
                adminBtn.style.padding = '4px 8px';
                adminBtn.style.fontSize = '12px';
                adminBtn.style.fontWeight = 'normal';
                adminBtn.style.fontFamily = 'Monaco, "Lucida Console", "Courier New", monospace';
                adminBtn.style.backgroundColor = '#000000';
                adminBtn.style.color = '#00cc00';
                adminBtn.style.border = '1px solid rgba(0, 204, 0, 0.3)';
                adminBtn.style.borderRadius = '2px';
                adminBtn.style.boxShadow = '0 0 4px rgba(0, 204, 0, 0.3)';
                adminBtn.style.textShadow = '0 0 2px rgba(0, 204, 0, 0.6)';
                adminBtn.style.cursor = 'pointer';
                adminBtn.style.transition = 'all 0.3s ease';
                adminBtn.style.letterSpacing = '1px';

                adminBtn.onmouseenter = () => {
                    adminBtn.style.boxShadow = '0 0 6px rgba(0, 204, 0, 0.5)';
                    adminBtn.style.textShadow = '0 0 3px rgba(0, 204, 0, 0.8)';
                    adminBtn.style.border = '1px solid rgba(0, 204, 0, 0.5)';
                };
                adminBtn.onmouseleave = () => {
                    adminBtn.style.boxShadow = '0 0 4px rgba(0, 204, 0, 0.3)';
                    adminBtn.style.textShadow = '0 0 2px rgba(0, 204, 0, 0.6)';
                    adminBtn.style.border = '1px solid rgba(0, 204, 0, 0.3)';
                };

                adminBtn.addEventListener('click', () => this.showPinModal());
                document.body.appendChild(adminBtn);

                // Show admin button on Ctrl+Shift+A (desktop) or tap the logo 5 times (mobile)
                let logoTapCount = 0;
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                        adminBtn.style.display = adminBtn.style.display === 'none' ? 'block' : 'none';
                    }
                });

                // Add mobile/iPad access via tapping "Combined Shortlist" text
                const header = document.querySelector('h2');
                if (header) {
                    header.addEventListener('click', () => {
                        logoTapCount++;
                        if (logoTapCount >= 5) {
                            logoTapCount = 0;
                            adminBtn.style.display = adminBtn.style.display === 'none' ? 'block' : 'none';
                        }
                        setTimeout(() => { logoTapCount = 0; }, 3000);
                    });
                }
            }

            showPinModal() {
                document.getElementById('adminPin').value = '';
                document.getElementById('pinError').style.display = 'none';
                const modal = new bootstrap.Modal(document.getElementById('pinModal'));
                modal.show();
            }


            startAdminSession() {
                if (this.adminSessionTimeout) {
                    clearTimeout(this.adminSessionTimeout);
                }

                this.adminSessionTimeout = setTimeout(() => {
                    this.exitAdminMode();
                }, this.ADMIN_TIMEOUT);

                localStorage.setItem('admin_session', Date.now().toString());
            }

            exitAdminMode() {
                this.isAdmin = false;
                if (this.adminSessionTimeout) {
                    clearTimeout(this.adminSessionTimeout);
                    this.adminSessionTimeout = null;
                }
                localStorage.removeItem('admin_session');
                this.updateAdminButtonVisibility();

                const adminModal = bootstrap.Modal.getInstance(document.getElementById('adminPanelModal'));
                if (adminModal) {
                    adminModal.hide();
                }
            }

            showAdminPanel() {
                this.populateAdminSalesList();
                const modal = new bootstrap.Modal(document.getElementById('adminPanelModal'));
                modal.show();
            }

            populateAdminSalesList() {
                const container = document.getElementById('adminSalesList');
                if (this.salesData.size === 0) {
                    container.innerHTML = '<p class="text-muted">No sales data available.</p>';
                    return;
                }

                let html = '<div class="row">';
                for (const [saleId, saleData] of this.salesData.entries()) {
                    const fileCount = saleData.files ? saleData.files.length : 0;
                    const rowCount = saleData.combinedData ? saleData.combinedData.length : 0;
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">${saleData.saleName || saleId}</h6>
                                    <p class="card-text small">
                                        Date: ${saleData.saleDate || 'Not set'}<br>
                                        Files: ${fileCount} | Horses: ${rowCount}
                                    </p>
                                    <button class="btn btn-sm btn-danger" onclick="window.combiner.deleteSaleAsAdmin('${saleId}')">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                container.innerHTML = html;
            }

            async deleteSaleAsAdmin(saleId) {
                if (!this.isAdmin) return;
                
                if (confirm(`Are you sure you want to delete the sale "${saleId}"? This action cannot be undone.`)) {
                    this.salesData.delete(saleId);
                    await this.saveSalesData();
                    
                    if (this.currentSaleId === saleId) {
                        this.currentSaleId = null;
                        this.files = [];
                        this.combinedData = [];
                        this.createTable();
                        this.updateSaleSelector();
                    }
                    
                    this.populateAdminSalesList();
                }
            }

            updateAdminButtonVisibility() {
                // Show/hide Clear button based on admin status
                const clearBtn = document.getElementById('clearBtn');
                if (clearBtn) {
                    clearBtn.style.display = this.isAdmin ? 'inline-block' : 'none';
                }
            }

            // ========== NEW HORSE FUNCTIONALITY ==========
            
            addNewHorse() {
                if (this.combinedData.length === 0) {
                    alert('Please upload at least one shortlist file before adding a new horse.');
                    return;
                }

                // Clear any existing filters temporarily to ensure new horse appears at top
                this.filters = {};
                
                // Create a new blank horse with all current columns
                const newHorse = {};
                const allColumns = new Set();
                
                // Get all possible columns from existing data
                this.combinedData.forEach(horse => {
                    Object.keys(horse).forEach(key => allColumns.add(key));
                });
                
                // Initialize all columns with empty values
                allColumns.forEach(column => {
                    if (column === '_uniqueId') return; // Skip internal fields
                    newHorse[column] = '';
                });
                
                // Set default values
                const timestamp = Date.now();
                newHorse['Hip'] = 'NEW';
                newHorse['Name'] = 'New Horse';
                newHorse['Overlap'] = 0;
                newHorse['_uniqueId'] = timestamp;

                // Add to beginning of data array
                this.combinedData.unshift(newHorse);
                
                // Recreate table
                this.createTable();
                this.updateStats();
                
                // Save the changes
                this.saveSaleDay(this.currentSaleId);
                
                alert('New horse added at the top of the list. Click any cell to edit the horse details.');
            }
        }

        // Initialize the application
        window.combiner = new ShortlistCombiner();
    </script>
    
</body>
</html>